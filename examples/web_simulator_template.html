<!DOCTYPE html>
<html>
<head>
    <title>SSD1305 Display Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .display-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #000;
            border-radius: 5px;
        }
        #display {
            border: 2px solid #333;
            /* Scale image with CSS instead of server-side for much better performance */
            width: 512px;
            height: 128px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 5px;
        }
        .info h2 {
            margin-top: 0;
            color: #2c5aa0;
        }
        .info ul {
            line-height: 1.6;
        }
        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .metric {
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 3px solid #4CAF50;
        }
        .metric strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SSD1305 Display Simulator</h1>
        <div class="display-container">
            <img id="display" src="/display.png" alt="OLED Display">
            <div style="margin-top: 10px; color: #4CAF50; font-weight: bold;">
                FPS: <span id="fps-counter">--</span> | 
                Mode: <span id="connection-mode">Polling</span>
            </div>
            <div id="keyboard-info" style="margin-top: 10px; color: #2c5aa0; font-size: 12px; display: none;">
                <strong>Keyboard enabled:</strong> Type any key to see it on the display
            </div>
        </div>
        <div class="info">
            <h2>Performance Metrics</h2>
            <div class="metrics">
                <div class="metric">
                    <strong>Sensor Read Time:</strong>
                    <span id="sensor-time">--</span> ms
                </div>
                <div class="metric">
                    <strong>Display Render Time:</strong>
                    <span id="render-time">--</span> ms
                </div>
                <div class="metric">
                    <strong>PNG Generation Time:</strong>
                    <span id="png-time">--</span> ms
                </div>
                <div class="metric">
                    <strong>Refresh Interval:</strong>
                    <span id="refresh-interval">--</span> ms
                </div>
            </div>
        </div>
        <div class="info">
            <h2>About This Demo</h2>
            <ul>
                <li><strong>Hot-pluggable sensors:</strong> Sensors are automatically detected
                    and show "n/a" when not available</li>
                <li><strong>Plugin system:</strong> Each sensor is a modular plugin that handles
                    its own initialization and error handling</li>
                <li id="sensor-mode"><strong>Sensor mode:</strong> Using <span id="mode-text">real sensors</span></li>
                <li><strong>Auto-refresh:</strong> Display updates automatically with 
                    <span id="update-mode">optimized polling interval</span></li>
                <li><strong>Benchmark:</strong> <a href="/benchmark" target="_blank">Static benchmark page</a> for measuring baseline server performance</li>
            </ul>
            <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-left: 3px solid #2c5aa0;">
                <strong>Current mode:</strong> <span id="mode-text">real sensors</span><br>
                <small>To use mocked sensors, restart the server with: <code>python ssd1305_web_simulator.py --use-mocks</code></small><br>
                <small>For WebSocket push updates: <code>python ssd1305_web_simulator.py --enable-websocket</code></small>
            </div>
        </div>
    </div>
    <script>
        // Check server mode (mocked or real sensors)
        const useMocks = false;  // This will be set by the server
        const WEBSOCKETS_AVAILABLE = false;  // This will be set by the server
        
        let currentRefreshInterval = 2000;  // Start with default
        let refreshIntervalId = null;
        let websocket = null;
        
        // Try to connect to WebSocket if available
        function connectWebSocket() {
            if (!WEBSOCKETS_AVAILABLE) {
                return false;
            }
            
            try {
                const wsPort = 8001;  // Default WebSocket port
                websocket = new WebSocket(`ws://${window.location.hostname}:${wsPort}`);
                
                websocket.onopen = function() {
                    console.log('WebSocket connected');
                    document.getElementById('connection-mode').textContent = 'WebSocket Push';
                    document.getElementById('update-mode').textContent = 'WebSocket push updates';
                    
                    // Show keyboard info when using mocks
                    if (useMocks) {
                        document.getElementById('keyboard-info').style.display = 'block';
                    }
                    
                    // Stop polling when WebSocket is active
                    if (refreshIntervalId) {
                        clearInterval(refreshIntervalId);
                        refreshIntervalId = null;
                    }
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'image') {
                        const img = document.getElementById('display');
                        img.src = 'data:image/png;base64,' + data.data;
                    }
                };
                
                websocket.onerror = function(error) {
                    console.log('WebSocket error, falling back to polling');
                    websocket = null;
                    startPolling();
                };
                
                websocket.onclose = function() {
                    console.log('WebSocket closed, falling back to polling');
                    websocket = null;
                    startPolling();
                };
                
                return true;
            } catch (e) {
                console.log('WebSocket not available, using polling');
                return false;
            }
        }
        
        // Auto-refresh the display image
        function refreshDisplay() {
            // Check if WebSocket is connected and active
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                return;  // Skip polling if WebSocket is active
            }

            var img = document.getElementById('display');
            img.src = '/display.png?' + new Date().getTime();
        }
        
        // Update performance stats and adjust refresh interval
        function updateStats() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('fps-counter').textContent = data.fps || '--';
                    document.getElementById('sensor-time').textContent = data.sensor_read_ms || '--';
                    document.getElementById('render-time').textContent = data.display_render_ms || '--';
                    document.getElementById('png-time').textContent = data.png_generation_ms || '--';
                    
                    // Update refresh interval based on recommended rate
                    if (data.recommended_refresh_ms && data.recommended_refresh_ms !== currentRefreshInterval) {
                        currentRefreshInterval = data.recommended_refresh_ms;
                        document.getElementById('refresh-interval').textContent = currentRefreshInterval;
                        
                        // Restart polling with new interval
                        if (refreshIntervalId && (!websocket || websocket.readyState !== WebSocket.OPEN)) {
                            clearInterval(refreshIntervalId);
                            startPolling();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                });
        }
        
        function startPolling() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            refreshIntervalId = setInterval(refreshDisplay, currentRefreshInterval);
            document.getElementById('connection-mode').textContent = 'Polling';
            const updateModeText = `polling every ${currentRefreshInterval}ms`;
            document.getElementById('update-mode').textContent = updateModeText;
            document.getElementById('refresh-interval').textContent = currentRefreshInterval;
        }
        
        // Send keyboard input via WebSocket
        function sendKeypress(key) {
            if (websocket && websocket.readyState === WebSocket.OPEN && useMocks) {
                websocket.send(JSON.stringify({
                    type: 'keypress',
                    key: key
                }));
            }
        }
        
        // Capture keyboard input when using WebSocket with mocks
        window.addEventListener('keydown', function(event) {
            // Only send if WebSocket is connected and we're using mocks
            if (websocket && websocket.readyState === WebSocket.OPEN && useMocks) {
                // Get the character
                const key = event.key;
                // Only send alphanumeric and space
                if (key.length === 1 && /[a-zA-Z0-9 ]/.test(key)) {
                    sendKeypress(key);
                    event.preventDefault();  // Prevent default browser behavior
                }
            }
        });
        
        // Load image immediately on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Try WebSocket first
            if (!connectWebSocket()) {
                // Fall back to polling
                refreshDisplay();
                startPolling();
            }
            
            updateStats();
            // Update stats less frequently
            setInterval(updateStats, 2000);
        });
    </script>
</body>
</html>
